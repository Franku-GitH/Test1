
Import-Module ActiveDirectory

# Nastavení proměnných
$OU = "OU=Computers,DC=example,DC=com"   # Cesta k OU
$Group = "DOMENA\\DelegovanaSkupina"     # Název skupiny (NetBIOS\Skupina)

# Mapování práv na GUID a dsacls parametry
$RightsMap = @(
    @{ Name = "Reset Password"; GUID = "00299570-246d-11d0-a768-00aa006e0529"; Dsacls = "CA;Reset Password;computer" },
    @{ Name = "Validated Write DNS Host Name"; GUID = "72e39547-7b18-11d1-adef-00c04fd8d5cd"; Dsacls = "SW;Validated write to DNS host name;computer" },
    @{ Name = "Validated Write SPN"; GUID = "f3a64788-5306-11d1-a9c5-0000f80367c1"; Dsacls = "SW;Validated write to service principal name;computer" },
    @{ Name = "Write userAccountControl"; GUID = "bf967a68-0de6-11d0-a285-00aa003049e2"; Dsacls = "WP;userAccountControl;computer" }
)

# Načtení ACL pro OU
$Acl = Get-Acl "AD:$OU"
$AccessRules = $Acl.Access | Where-Object { $_.IdentityReference -eq $Group }

Write-Host "`nKontrola oprávnění pro skupinu '$Group' v OU '$OU'`n"

foreach ($Right in $RightsMap) {
    $Guid = [Guid]$Right.GUID
    $HasRight = $AccessRules | Where-Object { $_.ObjectType -eq $Guid }
    if ($HasRight) {
        Write-Host "[OK] $($Right.Name)" -ForegroundColor Green
    } else {
        Write-Host "[CHYBÍ] $($Right.Name)" -ForegroundColor Red
        Write-Host " -> Přidej pomocí:" -ForegroundColor Yellow
        Write-Host "dsacls `"$OU`" /G `"$Group:$($Right.Dsacls)`" /I:S" -ForegroundColor Cyan
    }
}

# Kontrola Create/Delete Computer Objects
$CreateDelete = $AccessRules | Where-Object { $_.ActiveDirectoryRights -match "CreateChild|DeleteChild" }
if ($CreateDelete) {
    Write-Host "[OK] Create/Delete Computer Objects" -ForegroundColor Green
} else {
    Write-Host "[CHYBÍ] Create/Delete Computer Objects" -ForegroundColor Red
    Write-Host " -> Přidej pomocí:" -ForegroundColor Yellow
    Write-Host "dsacls `"$OU`" /G `"$Group:CCDC;computer`" /I:S" -ForegroundColor Cyan
}
